<!DOCTYPE html>
<html>
  <head>
    <title>Experiment</title>
    <script src="https://unpkg.com/jspsych@8.2.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-instructions@2.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-button-response@2.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-preload@2.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-likert@2.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-multi-choice@2.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.3"></script>
    <link href="https://unpkg.com/jspsych@8.2.2/css/jspsych.css" rel="stylesheet" type="text/css" />
    <link href="style.css" rel="stylesheet" type="text/css"></link>
    <script src="scenarios.js"> </script>  
    <style>
        /* reduce margins between likert scales */
        .jspsych-survey-likert-preamble {
            margin-bottom: 50px !important;
        }
        ul.jspsych-survey-likert-opts {
            padding-bottom: 32px !important;
        }
        label.jspsych-survey-likert-statement {
            padding-top: 0px !important;
        }
        /* move options in final attention check left */
        .final-attention-check div.jspsych-survey-multi-choice-option {
            margin: 0px !important;
            text-align: left;    
        }
        /* disable * in final attention check*/
        .final-attention-check .required {
            display: none !important;
            visibility: hidden !important;
        }
    </style>
  </head>
    <body>
    </body>
    <script>
        // Set jsPsych display element to wrapper
        const jsPsych = initJsPsych({
        on_finish: function() {
            jsPsych.data.displayData();

            jsPsych.data.get().filter({trty: "questions"}).localSave('csv','data.csv');
        }
    });
        
        // Define the timeline
        const timeline = [];
        
        // Preload images
        const preload = {
            type: jsPsychPreload,
            images: ['img/human.png', 'img/chip.png']
        };
        
        // Variable scenarios
        const scenarios = [
            { domain: "application", risk: "low", text: application_low_risk },
            { domain: "application", risk: "high", text: application_high_risk },
            { domain: "medical",     risk: "low", text: medical_low_risk },
            { domain: "medical",     risk: "high", text: medical_high_risk }
            ];

        const this_scenario =
            scenarios[Math.floor(Math.random() * scenarios.length)]; 

        // Variable reliabilities
        const values = [70, 77, 84, 91, 98];

        const sampled_values = Array.from({ length: 3 }, () =>
        values[Math.floor(Math.random() * values.length)]
        );

        const human_reliability = sampled_values[0];
        const ai_reliability = sampled_values[1];
        const hybrid_reliability = sampled_values[2];

        //Variable minimum viewing time for scenario
        const min_viewing_time_scenario = 10000;

        // ADD Condition information to the data
        jsPsych.data.addProperties({
            subject: "TODO for JATOS",
            domain: this_scenario.domain,
            risk: this_scenario.risk,
            human_reliability: human_reliability,
            ai_reliability: ai_reliability,
            hybrid_reliability: hybrid_reliability
        });

        // Welcome page and scenario page
        const trial_welcome = {
            type: jsPsychInstructions,
            pages: [
            `<div style="text-align: right;">
                <div style="text-align: left; width: 800px;">
                <h2>Welcome! Imagine the Following Scenario</h2>
                <p>${this_scenario.text}</p>
            </div>`
            ],
            button_label_next: `Next`,
            allow_backward: false,
            show_clickable_nav: true,
            on_load: () => {
                const nextBtn =
                document.querySelector("#jspsych-instructions-next") ||
                document.querySelector("button.jspsych-btn"); // fallback

                if (!nextBtn) return;

                nextBtn.disabled = true;
                nextBtn.style.opacity = "0.5";
                nextBtn.style.cursor = "not-allowed";

                setTimeout(() => {
                nextBtn.disabled = false;
                nextBtn.style.opacity = "1";
                nextBtn.style.cursor = "pointer";
                }, min_viewing_time_scenario);
            }
        };

        // Decision page
        // Define decision options 
        const decision_options = [
        {
            value: "human",
            label: "Human",
            reliability: human_reliability,
            images: [`<img src="img/human.png" style="width:100px;height:100px;border-radius:5px;">`],
            description: "You will be evaluated by an experienced human based on their expertise and judgment."
        },
        {
            value: "hybrid",
            label: "Human assisted by AI",
            reliability: hybrid_reliability,
            images: [
            `<img src="img/human.png" style="width:100px;height:100px;border-radius:5px;">`,
            `<img src="img/chip.png" style="width:100px;height:100px;border-radius:5px;">`
            ],
            description: "You will be evaluated by a combination of artificial intelligence analysis and human assessment."
        },
        {
            value: "ai",
            label: "AI",
            reliability: ai_reliability,
            images: [`<img src="img/chip.png" style="width:100px;height:100px;border-radius:5px;">`],
            description: "You will be evaluated by an experienced AI based on their expertise and judgment."
        }
        ];

        // Shuffle options
        const shuffled_options = jsPsych.randomization.shuffle(decision_options); 
        
        // Get data
        jsPsych.data.addProperties({
            option_order: shuffled_options.map(o => o.value)
        });

        const options_html = shuffled_options.map(opt => `
            <div class="option-button" data-value="${opt.value}" style="width:250px;">
                <div style="cursor:pointer;padding:20px;border:3px solid #ccc;border-radius:10px;height:264px;text-align:center;">
                <div style="display:flex;justify-content:center;gap:8px;margin-bottom:10px;">
                    ${opt.images.join("")}
                </div>
                <p style="font-weight:bold;">${opt.label}</p>
                <div style="text-align:left;border-top:2px solid #ccc;padding-top:16px;">
                    The ${opt.label} is ${opt.reliability}% reliable in their decisions.
                </div>
                </div>
                <div class="explanation" style="display:none;margin-top:8px;">
                    <!-- Dreieck -->
                    <div style="text-align:left; margin-left: 24px; margin-bottom:-9.5px;">
                        <svg width="28" height="14" viewBox="0 0 28 14">
                        <polygon points="14,0 28,14 0,14" fill="#ffffff"/>
                        <polyline points="0,14 14,0 28,14" fill="none" stroke="#ccc" stroke-width="2" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <!-- Box -->
                    <div style="
                        padding:20px;
                        border:2px solid #ccc;
                        border-radius:10px;
                        background:#ffffff;
                    ">
                        ${opt.description}
                    </div>
                </div>
            </div>
            `).join("");

        const trial_decision = {
            type: jsPsychHtmlButtonResponse,
            stimulus: `
            <div style="text-align: left; height: 800px; width: 800px;">
                <p style="margin-bottom: -16px;"><b>Your scenario:</b></p>
                <p style="margin-bottom: 40px; height: 88px;">${this_scenario.text}</p>
                <h3 style="margin-bottom: 32px; text-align: left;">By whom would you want to be evaluated in this situation?</h3>
                
                <div id="options-container" style="display:flex;gap:20px;justify-content:left;flex-wrap:wrap; height: 514px;">
                ${options_html}
                </div>
                <div style="text-align:center;margin-top:24px;">
                <button id="next-button" class="jspsych-btn" disabled style="float:right;" disabled>Next ></button>
                </div>
            `,
            choices: [],
            response_ends_trial: false,
            on_load: function() {
                // Add hover and click functionality
                const optionButtons = document.querySelectorAll('.option-button');
                let selectedValue = null;
                
                optionButtons.forEach(button => {
                    const innerDiv = button.querySelector('div:first-child');

                    if (innerDiv) {
                        // Hover enter (only on the top box)
                        innerDiv.addEventListener('mouseenter', function() {
                            const parent = button;
                            if (!selectedValue || !parent.classList.contains('selected')) {
                                parent.querySelector('.explanation').style.display = 'block';
                                innerDiv.style.backgroundColor = '#f5f5f5';
                            }
                        });

                        // Hover leave (only on the top box)
                        innerDiv.addEventListener('mouseleave', function() {
                            const parent = button;
                            if (!selectedValue || !parent.classList.contains('selected')) {
                                parent.querySelector('.explanation').style.display = 'none';
                                innerDiv.style.backgroundColor = 'white';
                            }
                        });

                        // Click to select (only on the top box)
                        innerDiv.addEventListener('click', function(e) {
                            e.preventDefault();

                            // Remove selection from all buttons
                            optionButtons.forEach(b => {
                                const bInnerDiv = b.querySelector('div:first-child');
                                b.classList.remove('selected');
                                if (bInnerDiv) {
                                    bInnerDiv.style.borderColor = '#ccc';
                                    bInnerDiv.style.backgroundColor = 'white';
                                } else {
                                    b.style.borderColor = '#ccc';
                                    b.style.backgroundColor = 'white';
                                }
                                b.querySelector('.explanation').style.display = 'none';
                            });

                            selectedValue = button.dataset.value;
                            // Select this button
                            button.classList.add('selected');
                            innerDiv.style.borderColor = '#007bff';
                            innerDiv.style.backgroundColor = '#e7f3ff';
                            button.querySelector('.explanation').style.display = 'block';
                        });
                    }
                });

                // Enable next button when an option is selected
                const nextButton = document.getElementById('next-button');
                optionButtons.forEach(button => {
                    const innerDiv = button.querySelector('div:first-child');
                    if (innerDiv) {
                        innerDiv.addEventListener('click', function() {
                            nextButton.disabled = false;
                            nextButton.style.display = 'block';
                        });
                    }
                });

                // Handle next button click
                nextButton.addEventListener('click', function() {
                    if (!nextButton.disabled && selectedValue) {
                        jsPsych.finishTrial({
                            selection: selectedValue
                        });
                    }
                });
            },
            data: {task: 'choice', trty: 'questions'},
            on_finish: function(data) {
            }
        };
        
        // Manipulation check trial
        const risk_scale = ["<h3 style='margin-top: 16px;'>Not risky at all</h3>", "", "","", "", "", "<h3 style='margin-top: 16px;'>Very risky</h3>"];

        const trial_manipulation = {
            type: jsPsychSurveyLikert,
            data: {task: 'risk', trty: 'questions'},
            questions: [
                {prompt: "<h3 style='width: 800px; margin-bottom: 32px; text-align: left;'>How risky did the situation in the scenario feel to you?</h3>", name: 'risk', labels: risk_scale, required: true},
            ],
            button_label: "Next >",
            on_load: function () {
                const btn = document.querySelector(".jspsych-btn");

                if (!btn) return;
                // initial disabled look
                btn.disabled = true;
                btn.style.opacity = "0.5";
                btn.style.cursor = "not-allowed";
                btn.style.display = "block";
                btn.style.marginLeft = "auto";
                btn.style.marginRight = "0";

                // Get Likert-Inputs 
                const inputs = document.querySelectorAll(
                    "input[type='radio']"
                );

                inputs.forEach(input => {
                    input.addEventListener("change", () => {
                    btn.disabled = false;
                    btn.style.opacity = "1";
                    btn.style.cursor = "pointer";
                    });
                });
                }
        };

        // affinity for technology trial
        const taegsScale = ["<h3 style='margin-top: 16px;'>Strongly disagree</h3>", "<h3 style='margin-top: 16px;'>Somewhat disagree</h3>", "<h3 style='margin-top: 16px;'>Neither agree nor disagree</h3>", "<h3 style='margin-top: 16px;'>Somewhat agree</h3>", "<h3 style='margin-top: 16px;'>Strongly agree</h3>"];
        const instructions_taegs = {
                    type: jsPsychHtmlKeyboardResponse,
                    on_load: () => {
                        const btn = document.getElementById("continue-btn");
                        if (btn) {
                        btn.addEventListener("click", () => {
                            jsPsych.finishTrial({ response: "button" });
                        });
                        }
                    },
                    stimulus: `
                        <div style="
                            max-width: 800px;
                            margin: 0 auto;
                            padding: 24px 28px;
                            line-height: 1.6;
                            font-size: 18px;
                            text-align: left;
                        ">
                            <p>This next questionnaire explores your personal opinion on various aspects of electronic devices, and your experience using these devices.</p>
                            <p>The term "electronic devices" refers to devices such as computers, tablets, cell phones, digital cameras, smartwatches, digital smart home assistants, ATMs, ticket machines or new systems in cars such as navigation systems.</p>
                            <p>We are not referring to tools such as drills, saws, hammers, lawn mowers or simple household appliances such as toasters, hand mixers, kettles, or vehicles and vehicle engines.</p>
                        <div style="text-align: center; margin-top: 24px; float:right;">
                            <button id="continue-btn" class="jspsych-btn">
                            Next >
                            </button>
                        </div>
                        </div>
                    `
                };

        const taegs = {
            type: jsPsychSurveyLikert,
            preamble: "<p style='width: 800px; text-align: left; margin-bottom: 24px;'>Below you will find a series of statements. For each statement, please indicate how it applies to you personally. To do so, check the box on the right that best matches your opinion.</p>",
            scale_width: 800,
            data: {task: 'taegs', trty: 'questions'},
            questions: [
                {prompt: "<h3 style='width: 800px; text-align: left; margin-bottom: 0px;'>Electronic devices lead to intellectual impoverishment.</h3>", name: 'taegs_1', labels: taegsScale, required: true},
                {prompt: "<h3 style='width: 800px; text-align: left; margin-bottom: 0px;'>Electronic devices make my everyday life easier.</h3>", name: 'taegs_2', labels: taegsScale, required: true},
                {prompt: "<h3 style='width: 800px; text-align: left; margin-bottom: 0px;'>I am excited when a new electronic device comes on the market.</h3>", name: 'taegs_3', labels: taegsScale, required: true},
                {prompt: "<h3 style='width: 800px; text-align: left; margin-bottom: 0px;'>I know a lot about electronic devices.</h3>", name: 'taegs_4', labels: taegsScale, required: true}
            ],
            button_label: "Next >",
            on_load: function() {
                const btn = document.querySelector(".jspsych-btn");
                if (!btn) return;

                // initial disabled style
                btn.disabled = true;
                btn.style.opacity = "0.5";
                btn.style.cursor = "not-allowed";
                btn.style.display = "block";
                btn.style.marginLeft = "auto";
                btn.style.marginRight = "0";

                // Get inputs
                const inputs = document.querySelectorAll("input[type='radio']");

                inputs.forEach(input => {
                    input.addEventListener("change", () => {
                        // check if all questions are answered
                        const allAnswered = Array.from(
                            document.querySelectorAll("div.jspsych-survey-likert-question")
                        ).every(q => q.querySelector("input[type='radio']:checked"));

                        if (allAnswered) {
                            btn.disabled = false;
                            btn.style.opacity = "1";
                            btn.style.cursor = "pointer";
                        }
                    });
                });
            }
        };

        // Trash question trial
        const attention_final = {
            type: jsPsychSurveyMultiChoice,
            // Add a specific class for styling this trial
            css_classes: ['final-attention-check'],
            button_label: "Next >",
            data: {task: 'attention_final', trty: 'questions'},
            questions: [
                {
                    prompt: `<div style='width: 800px; margin-bottom: 32px; text-align: left;'><h3>One last question: Can your responses be used for the study analysis?</h3>This answer is especially important for us and the results of the study. Your response to this question is completely anonymous.
                            Please answer honestly; it is not a problem if you say that the data should not be used for any reason (e.g., if you simply 'clicked through' or if you did not seriously answer the questions).</div>`,
                    options: ["Yes, my responses can be used.", "No, my responses should not be used."],
                    horizontal: false,
                    required: true,
                    name: 'attention_final'
                }
            ],
             on_load: function() {
                const btn = document.querySelector(".jspsych-btn");
                if (!btn) return;

                // initial disabled style
                btn.disabled = true;
                btn.style.opacity = "0.5";
                btn.style.cursor = "not-allowed";
                btn.style.display = "block";
                btn.style.marginLeft = "auto";
                btn.style.marginRight = "0";

                // Get inputs
                const inputs = document.querySelectorAll("input[type='radio'], input[type='checkbox']");

                inputs.forEach(input => {
                    input.addEventListener("change", () => {
                        // check if all questions are answered
                        const allAnswered = Array.from(
                            document.querySelectorAll("div.jspsych-survey-multi-choice-question")
                        ).every(q => q.querySelector("input[type='radio']:checked"));

                        if (allAnswered) {
                            btn.disabled = false;
                            btn.style.opacity = "1";
                            btn.style.cursor = "pointer";
                        }
                    });
                });
            }   
        };

        // End trial
        const trial_end = {
            type: jsPsychHtmlKeyboardResponse,
            on_load: () => {
                        const btn = document.getElementById("continue-btn");
                        if (btn) {
                        btn.addEventListener("click", () => {
                            jsPsych.finishTrial({ response: "button" });
                        });
                        }
                    },
            stimulus:
            `<div style="text-align: right;">
                <div style="text-align: left; width: 800px;">
                <h2 style="line-height: 1.2;">Thank you for your participation!</h2>
                <p>Thank you for taking part. In this study, we examined how people prefer decisions to be made—by humans, 
                    AI systems, or both—across different everyday and medical-style scenarios that varied in risk level and 
                    in the reliability of the human, AI, or combined decision option.</p>
                <br> <br>
                <p> Press any key on the keyboard or press the button below to finish the experiment. Please wait until you are 
                    redirected to Prolific. </p> 

                <div style="text-align: center; margin-top: 24px; float:right;">
                            <button id="continue-btn" class="jspsych-btn">
                            End Experiment
                            </button>
                        </div>
            </div>`
            ,
            show_clickable_nav: false
        };

        /* 
        //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        
        
        Push things to timeline 


        //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        */
        
        timeline.push(preload);

        timeline.push(trial_welcome); 

        timeline.push(trial_decision);
        timeline.push(trial_manipulation); 
        timeline.push(instructions_taegs, taegs);

        timeline.push(attention_final); 
        timeline.push(trial_end);

        //Run the experiment
        jsPsych.run(timeline);

  </script>
</html>