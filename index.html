<!DOCTYPE html>
<html>
  <head>
    <title>Experiment</title>
    <script src="https://unpkg.com/jspsych@8.2.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-instructions@2.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-button-response@2.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-preload@2.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-likert@2.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-multi-choice@2.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.3"></script>
    <link href="https://unpkg.com/jspsych@8.2.2/css/jspsych.css" rel="stylesheet" type="text/css" />
    <link href="style.css" rel="stylesheet" type="text/css"></link>
    <script src="scenarios.js"> </script>  
        
  </head>
    <body>
    </body>
    <script>
        // Set jsPsych display element to wrapper
        const jsPsych = initJsPsych({
        on_finish: function() {
            jsPsych.data.displayData();

            jsPsych.data.get().filter({trty: "questions"}).localSave('csv','data.csv');
        }
    });
        
        // Define the timeline
        const timeline = [];
        
        // Preload images
        const preload = {
            type: jsPsychPreload,
            images: ['img/human.png', 'img/ai.png']
        };
        
        // Variable scenarios
        const scenarios = [
            { domain: "application", risk: "low", text: application_low_risk },
            { domain: "application", risk: "high", text: application_high_risk },
            { domain: "medical",     risk: "low", text: medical_low_risk },
            { domain: "medical",     risk: "high", text: medical_high_risk }
            ];

        const this_scenario =
            scenarios[Math.floor(Math.random() * scenarios.length)]; 

        // Variable reliabilities
        const values = [70, 77, 84, 91, 98];

        const sampled_values = Array.from({ length: 3 }, () =>
        values[Math.floor(Math.random() * values.length)]
        );

        const human_reliability = sampled_values[0];
        const ai_reliability = sampled_values[1];
        const hybrid_reliability = sampled_values[2];

        //Variable minimum viewing time for scenario
        const min_viewing_time_scenario = 10000;

        // ADD Condition information to the data
        jsPsych.data.addProperties({
            subject: "TODO for JATOS",
            domain: this_scenario.domain,
            risk: this_scenario.risk,
            human_reliability: human_reliability,
            ai_reliability: ai_reliability,
            hybrid_reliability: hybrid_reliability
        });

        // Welcome page and scenario page
        const trial_welcome = {
            type: jsPsychInstructions,
            pages: [
            `<div style="text-align: right;">
                <div style="text-align: left; width: 1000px;">
                <h2>Welcome! Imagine the Following Scenario</h2>
                <p>${this_scenario.text}</p>
            </div>`
            ],
            button_label_next: `Next`,
            allow_backward: false,
            show_clickable_nav: true,
            on_load: () => {
                const nextBtn =
                document.querySelector("#jspsych-instructions-next") ||
                document.querySelector("button.jspsych-btn"); // fallback

                if (!nextBtn) return;

                nextBtn.disabled = true;
                nextBtn.style.opacity = "0.5";
                nextBtn.style.cursor = "not-allowed";

                setTimeout(() => {
                nextBtn.disabled = false;
                nextBtn.style.opacity = "1";
                nextBtn.style.cursor = "pointer";
                }, min_viewing_time_scenario);
            }
        };

        // Decision page
        const trial_decision = {
            type: jsPsychHtmlButtonResponse, //TODO hier muss nochmal das Szenario eingeblendet werden: kann man über <p>${this_scenario.text}</p> tun, aber ich will hier nichts zerschiessen
            //TODO: das "without assistance" wording finde ich noch etwas unglücklich. vielleicht können wir das anders/besser beschreiben
            //TODO: die Reihenfolge random wäre noch super, aber auch hier will ich nichts kaputtmachen
            stimulus: `
            <div style="text-align: right; height: 600px;">
                <h2 style="margin-bottom: 60px;">By whom would you want to be evaluated in this situation?</h2>
                
                <div id="options-container" style="display: flex; justify-content: center; gap: 30px; margin-bottom: 40px; flex-wrap: wrap;">
                    
                    <!-- Option 1: Human -->
                    <div class="option-button" data-value="human" style="
                        border-radius: 10px;
                        width: 250px;
                        background-color: white;
                        box-sizing: border-box;
                    ">
                        <div style="
                            cursor: pointer;
                            padding: 20px;
                            border: 3px solid #ccc;
                            border-radius: 10px;
                            width: 250px;
                            text-align: center;
                            box-sizing: border-box;
                        ">
                            <img src="img/human.png" alt="Human" style="width: 100px; height: 100px; margin: 0 auto 10px; border-radius: 5px; display: block;">
                            <p style="font-weight: bold; font-size: 16px; margin: 10px 0;">Human</p>
                            <div style="text-align: left; font-size: 16px; color: #555; margin-top: 10px; padding-top: 10px; border-top: 2px solid #ccc;">
                                The human without assistance is `+human_reliability+`% reliable in their decisions.
                            </div>
                        </div>
                        <div class="explanation" style="display: none; position: relative; text-align: left; font-size: 16px; color: #555; margin-top: 20px; padding: 20px; border: 2px solid #ccc; border-radius: 10px;">
                            <svg width="28" height="14" viewBox="0 0 28 14" style="position:absolute; top:-14px; left:24px; z-index:0;" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                                <!-- outer border triangle (stroke) -->
                                <polygon points="0,14 14,0 28,14" fill="none" stroke="#ccc" stroke-width="2" />
                                <!-- inner white triangle to cover the overlap (no stroke) -->
                                <polygon points="2,14 14,2 26,14" fill="#fff" stroke="none" />
                            </svg>
                            You will be evaluated by an experienced human based on their expertise and judgment.
                        </div>
                    </div>
                    
                    <!-- Option 2: Human & AI -->
                    <div class="option-button" data-value="hybrid" style="
                        border-radius: 10px;
                        width: 250px;
                        background-color: white;
                        box-sizing: border-box;
                    ">
                        <div style="
                            cursor: pointer;
                            padding: 20px;
                            border: 3px solid #ccc;
                            border-radius: 10px;
                            width: 250px;
                            text-align: center;
                            box-sizing: border-box;
                        ">
                            <div style="display: flex; justify-content: center; align-items: center; gap: 8px; margin-bottom: 10px;">
                                <img src="img/human.png" alt="Human" style="width: 100px; height: 100px; border-radius: 5px; display: block;">
                                <img src="img/ai.png" alt="AI" style="width: 100px; height: 100px; border-radius: 5px; display: block;">
                            </div>
                            <p style="font-weight: bold; font-size: 16px; margin: 10px 0;">Human and AI System</p>
                            <div style="text-align: left; font-size: 16px; color: #555; margin-top: 10px; padding-top: 10px; border-top: 2px solid #ccc;">
                                The human assisted by AI is `+hybrid_reliability+`% reliable in their decisions.
                            </div>
                        </div>
                        <div class="explanation" style="display: none; position: relative; text-align: left; font-size: 16px; color: #555; margin-top: 20px; padding: 20px; border: 2px solid #ccc; border-radius: 10px;">
                            <svg width="28" height="14" viewBox="0 0 28 14" style="position:absolute; top:-14px; left:24px; z-index:0;" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                                <!-- outer border triangle (stroke) -->
                                <polygon points="0,14 14,0 28,14" fill="none" stroke="#ccc" stroke-width="2" />
                                <!-- inner white triangle to cover the overlap (no stroke) -->
                                <polygon points="2,14 14,2 26,14" fill="#fff" stroke="none" />
                            </svg>
                            You will be evaluated by a combination of artificial intelligence analysis and human assessment.
                        </div>
                    </div>
                    
                    <!-- Option 3: AI -->
                    <div class="option-button" data-value="ai" style="
                        border-radius: 10px;
                        width: 250px;
                        background-color: white;
                        box-sizing: border-box;
                    ">
                        <div style="
                            cursor: pointer;
                            padding: 20px;
                            border: 3px solid #ccc;
                            border-radius: 10px;
                            width: 250px;
                            text-align: center;
                            box-sizing: border-box;
                        ">
                            <img src="img/ai.png" alt="AI System" style="width: 100px; height: 100px; margin: 0 auto 10px; border-radius: 5px; display: block;">
                            <p style="font-weight: bold; font-size: 16px; margin: 10px 0;">AI System</p>
                            <div style="text-align: left; font-size: 16px; color: #555; margin-top: 10px; padding-top: 10px; border-top: 2px solid #ccc;">
                                The AI without assistance is `+ai_reliability+`% reliable in their decisions.
                            </div>
                        </div>
                        <div class="explanation" style="display: none; position: relative; text-align: left; font-size: 16px; color: #555; margin-top: 20px; padding: 20px; border: 2px solid #ccc; border-radius: 10px;">
                            <svg width="28" height="14" viewBox="0 0 28 14" style="position:absolute; top:-14px; left:24px; z-index:0;" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                                <!-- outer border triangle (stroke) -->
                                <polygon points="0,14 14,0 28,14" fill="none" stroke="#ccc" stroke-width="2" />
                                <!-- inner white triangle to cover the overlap (no stroke) -->
                                <polygon points="2,14 14,2 26,14" fill="#fff" stroke="none" />
                            </svg>
                            You will be evaluated by an experienced AI based on their expertise and judgment.
                        </div>
                    </div>
                    
                </div>
                
                <!-- Next-button is created dynamically after a selection is made -->
                <div style="display: flex; justify-content: flex-end; margin-top: 40px;">
                    <button id="next-button" class="jspsych-btn" style="display: none;" disabled>Next ></button>
                </div>
            </div>
            `,
            choices: [],
            response_ends_trial: false,
            on_load: function() {
                // Add hover and click functionality
                const optionButtons = document.querySelectorAll('.option-button');
                let selectedValue = null;
                
                optionButtons.forEach(button => {
                    const innerDiv = button.querySelector('div:first-child');

                    if (innerDiv) {
                        // Hover enter (only on the top box)
                        innerDiv.addEventListener('mouseenter', function() {
                            const parent = button;
                            if (!selectedValue || !parent.classList.contains('selected')) {
                                parent.querySelector('.explanation').style.display = 'block';
                                innerDiv.style.backgroundColor = '#f5f5f5';
                            }
                        });

                        // Hover leave (only on the top box)
                        innerDiv.addEventListener('mouseleave', function() {
                            const parent = button;
                            if (!selectedValue || !parent.classList.contains('selected')) {
                                parent.querySelector('.explanation').style.display = 'none';
                                innerDiv.style.backgroundColor = 'white';
                            }
                        });

                        // Click to select (only on the top box)
                        innerDiv.addEventListener('click', function(e) {
                            e.preventDefault();

                            // Remove selection from all buttons
                            optionButtons.forEach(b => {
                                const bInnerDiv = b.querySelector('div:first-child');
                                b.classList.remove('selected');
                                if (bInnerDiv) {
                                    bInnerDiv.style.borderColor = '#ccc';
                                    bInnerDiv.style.backgroundColor = 'white';
                                } else {
                                    b.style.borderColor = '#ccc';
                                    b.style.backgroundColor = 'white';
                                }
                                b.querySelector('.explanation').style.display = 'none';
                            });

                            selectedValue = button.dataset.value;
                            // Select this button
                            button.classList.add('selected');
                            innerDiv.style.borderColor = '#007bff';
                            innerDiv.style.backgroundColor = '#e7f3ff';
                            button.querySelector('.explanation').style.display = 'block';
                        });
                    }
                });

                // Enable next button when an option is selected
                const nextButton = document.getElementById('next-button');
                optionButtons.forEach(button => {
                    const innerDiv = button.querySelector('div:first-child');
                    if (innerDiv) {
                        innerDiv.addEventListener('click', function() {
                            nextButton.disabled = false;
                            nextButton.style.display = 'block';
                        });
                    }
                });

                // Handle next button click
                nextButton.addEventListener('click', function() {
                    if (!nextButton.disabled && selectedValue) {
                        jsPsych.finishTrial({
                            selection: selectedValue
                        });
                    }
                });
            },
            data: {task: 'choice', trty: 'questions'},
            on_finish: function(data) {
            }
        };
        
        // Manipulation check trial
        const risk_scale = ["Not risky at all", "", "","", "", "", "Very risky"];

        const trial_manipulation = {
            type: jsPsychSurveyLikert,
            data: {task: 'risk', trty: 'questions'},
            questions: [
                {prompt: "How risky did the situation in the scenario feel to you?", name: 'risk', labels: risk_scale, required: true},
            ]
        };

        // affinity for technology trial
        const taegsScale = ["Strongly disagree", "Somewhat disagree", "Neither agree nor disagree", "Somewhat agree", "Strongly agree"];
        const instructions_taegs = {
                    type: jsPsychHtmlKeyboardResponse,
                    on_load: () => {
                        const btn = document.getElementById("continue-btn");
                        if (btn) {
                        btn.addEventListener("click", () => {
                            jsPsych.finishTrial({ response: "button" });
                        });
                        }
                    },
                    stimulus: `
                        <div style="
                            max-width: 700px;
                            margin: 0 auto;
                            padding: 24px 28px;
                            line-height: 1.6;
                            font-size: 16px;
                            text-align: left;
                        ">
                            <p>This next questionnaire explores your personal opinion on various aspects of electronic devices, and your experience using these devices.</p>
                            <p>The term "electronic devices" refers to devices such as computers, tablets, cell phones, digital cameras, smartwatches, digital smart home assistants, ATMs, ticket machines or new systems in cars such as navigation systems.</p>
                            <p>We are not referring to tools such as drills, saws, hammers, lawn mowers or simple household appliances such as toasters, hand mixers, kettles, or vehicles and vehicle engines.</p>
                            <p> Press the any key to continue or press the button below. </p>
                        <div style="text-align: center; margin-top: 16px;">
                            <button id="continue-btn" class="jspsych-btn">
                            Continue
                            </button>
                        </div>
                        </div>
                    `
                };

        const taegs = {
            type: jsPsychSurveyLikert,
            preamble: "Below you will find a series of statements. For each statement, please indicate how it applies to you personally. To do so, check the box on the right that best matches your opinion.",
            scale_width: 450,
            data: {task: 'taegs', trty: 'questions'},
            questions: [
                {prompt: "Electronic devices lead to intellectual impoverishment.", name: 'taegs_1', labels: taegsScale, required: true},
                {prompt: "Electronic devices make my everyday life easier.", name: 'taegs_2', labels: taegsScale, required: true},
                {prompt: "I am excited when a new electronic device comes on the market.", name: 'taegs_3', labels: taegsScale, required: true},
                {prompt: "I know a lot about electronic devices.", name: 'taegs_4', labels: taegsScale, required: true}
            ]
        };

        // Trash question trial
        const attention_final = {
            type: jsPsychSurveyMultiChoice,
            // Add a specific class for styling this trial
            css_classes: ['final-attention-check'],
            button_label: "Continue",
            data: {task: 'attention_final', trty: 'questions'},
            questions: [
            {
                    prompt: "One last question: Can your responses be used for the study analysis? <br> <br> This answer is especially important for us and the results of the study. Your response to this question is completely anonymous. " +
                    "Please answer honestly; it is not a problem if you say that the data should not be used for any reason (e.g., if you simply 'clicked through,' or if you did not seriously answer the questions).",
                options: ["Yes, my responses can be used.", "No, my responses should not be used."],
                horizontal: false,
                required: true,
                name: 'attention_final'
            }
            ]
        }

        // End trial
        const trial_end = {
            type: jsPsychHtmlKeyboardResponse,
            on_load: () => {
                        const btn = document.getElementById("continue-btn");
                        if (btn) {
                        btn.addEventListener("click", () => {
                            jsPsych.finishTrial({ response: "button" });
                        });
                        }
                    },
            stimulus:
            `<div style="text-align: right;">
                <div style="text-align: left; width: 1000px;">
                <h1 style="line-height: 1.2;">Thank you for your participation!</h1>
                <p>Thank you for taking part. In this study, we examined how people prefer decisions to be made—by humans, 
                    AI systems, or both—across different everyday and medical-style scenarios that varied in risk level and 
                    in the reliability of the human, AI, or combined decision option.</p>
                <br> <br>
                <p> Press any key on the keyboard or press the button below to finish the experiment. Please wait until you are 
                    redirected to Prolific. </p> 


                <div style="text-align: center; margin-top: 16px;">
                            <button id="continue-btn" class="jspsych-btn">
                            Continue
                            </button>
                        </div>
            </div>`
            ,
            show_clickable_nav: false
        };

        /* 
        //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        
        
        Push things to timeline 


        //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        */
        
        timeline.push(preload);

        timeline.push(trial_welcome); 

        timeline.push(trial_decision);
        timeline.push(trial_manipulation); 
        timeline.push(instructions_taegs, taegs);

        timeline.push(attention_final); 
        timeline.push(trial_end);

        //Run the experiment
        jsPsych.run(timeline);

  </script>
</html>